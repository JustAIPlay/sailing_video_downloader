# 飞书多维表格批量下载助手

一个 Chrome 浏览器扩展，用于从飞书多维表格中批量下载视频/附件文件。

## 功能特点

- 批量下载飞书多维表格中的视频/附件
- 支持分页获取，自动处理大量数据
- 脚本号筛选功能，可指定从某个序号开始下载
- 自动去重，已下载的文件不会重复下载
- 断点续传，支持中断后继续下载
- 停止/重置功能，方便处理异常情况
- 字段过滤，只获取需要的数据，减少网络传输
- 自定义文件名和保存路径

## 安装方法

### 方式一：加载已解压的扩展

1. 下载或克隆本项目源码
2. 打开 Chrome 浏览器，进入 `chrome://extensions/`
3. 开启右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目文件夹

### 方式二：打包安装

1. 在 `chrome://extensions/` 页面点击"打包扩展程序"
2. 选择项目根目录
3. 生成 `.crx` 文件后拖拽到浏览器安装

## 快速开始

### 第一步：获取飞书 API 凭证

访问 [飞书开放平台](https://open.feishu.cn/) 创建应用并获取：
- **App ID**
- **App Secret**

### 第二步：获取表格信息

打开你的飞书多维表格，URL 格式如下：
```
https://feishu.cn/base/N6xxxxx/dashxxxxx?page=bascxxxxx&table=viroxxxxx
```

从 URL 中提取：
- **Base Token**: `bascxxxxx` (page= 后面的部分)
- **Table ID**: `viroxxxxx` (table= 后面的部分)

### 第三步：配置扩展

1. 点击扩展图标打开侧边栏
2. 点击右上角的 **⚙️ 设置** 按钮
3. 填写配置信息：
   - App ID
   - App Secret
   - Base Token
   - Table ID
   - 视频链接字段（默认：`视频链接`）
   - 脚本号字段（默认：`脚本号`）
   - 起始脚本号（可选）
   - 文件名字段（默认：`任务名称`）
   - 保存路径（默认：`FeishuVideos`）
4. 点击 **保存配置**

### 第四步：开始下载

返回主页面，点击 **开始下载** 按钮即可。

## 配置说明

### API 配置（必需）

| 配置项 | 说明 | 获取方式 |
|--------|------|---------|
| **App ID** | 飞书应用的凭证 | [飞书开放平台](https://open.feishu.cn/) |
| **App Secret** | 飞书应用的密钥 | 同上 |
| **Base Token** | 多维表格的应用标识 | 从飞书表格 URL 中获取 |
| **Table ID** | 具体数据表的标识 | 从飞书表格 URL 中获取 |

### 字段配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **视频链接字段** | `视频链接` | 存放视频 URL 的字段名 |
| **脚本号字段** | `脚本号` | 用于筛选下载范围的字段名 |
| **起始脚本号** | 留空 | 从哪个脚本号开始下载（可选） |
| **文件名字段** | `任务名称` | 用于重命名下载文件的字段名 |
| **保存路径** | `FeishuVideos` | 下载文件保存的相对路径 |

## 使用技巧

### 脚本号筛选

假设表格数据：
```
JQym000001 - 视频1
JQym000002 - 视频2
...
JQym000100 - 视频100
```

设置起始脚本号为 `JQym000050`，只会下载第 50-100 条记录（序号小于 50 的会被跳过）。

### 分批下载

如果文件很多（如 1000+ 个）：
1. 先下载第一批（设置起始脚本号 `JQym000001`）
2. 下载完成后，修改起始脚本号为 `JQym000200`
3. 继续下载下一批

### 断点续传

工具会自动记录已下载的文件：
- 已下载的文件不会重复下载
- 中途停止后可以继续下载剩余文件
- 清除缓存后才会重新下载所有文件

## 停止和重置

### 停止下载

当遇到以下情况时，可以点击红色 **停止下载** 按钮：
- 下载配置错误
- 大量文件下载失败
- 程序卡死或死循环

停止后：
- 已下载的文件会保存
- 待下载队列会被清空
- 显示 **重置状态** 按钮

### 重置状态

点击橙色 **重置状态** 按钮：
- 清空所有状态
- 恢复初始状态
- 可以重新开始下载

## 调试模式

在浏览器控制台（按 F12 打开）执行：

```javascript
enableDebug()   // 开启调试模式
disableDebug()  // 关闭调试模式
```

调试模式会：
- 输出详细的运行日志
- 只下载前 20 个文件（测试用）
- 显示 API 请求详情（敏感信息已脱敏）

## 常见问题

### Q1: 提示"找不到字段 xxx"

**解决：** 检查字段名是否正确，包括：
- 字段名拼写
- 是否有多余的空格
- 字段类型是否正确

### Q2: 下载一直停在"处理中"

**解决：**
1. 点击 **停止下载** 按钮
2. 点击 **重置状态**
3. 检查网络和配置
4. 重新开始

### Q3: 部分文件下载失败

**解决：**
- 检查文件 URL 是否有效
- 查看控制台错误信息（F12）
- 失败的文件可以重新下载（不会影响已成功的）

### Q4: 如何确认文件已下载？

**方法：**
- 查看浏览器下载记录
- 检查保存路径（默认 `下载/FeishuVideos/`）
- 查看工具的日志输出

## 文件保存位置

默认路径：**下载/FeishuVideos/**

可在设置中修改 `保存路径`，例如：
- `FeishuVideos/Videos` - 下载到子文件夹
- `Project/Videos` - 下载到指定项目文件夹

## 隐私说明

- 所有配置保存在本地浏览器
- 不会上传任何数据到外部服务器
- 敏感信息（App Secret 等）只在本地使用

## 项目结构

```
feishu-downloader/
├── manifest.json      # Chrome 扩展清单文件
├── popup.html         # 侧边栏页面主界面
├── popup.js           # 主要逻辑脚本
├── background.js      # 后台服务脚本
├── style.css          # 样式文件
├── icon16.png         # 扩展图标（16x16）
├── icon32.png         # 扩展图标（32x32）
├── icon48.png         # 扩展图标（48x48）
├── icon128.png        # 扩展图标（128x128）
└── README.md          # 使用说明
```

## 技术特点

- 使用 `chrome.storage.local` 存储配置和历史记录
- 支持字段过滤，减少数据传输量
- 自动分页获取所有记录（不限制 500 条）
- 并发下载控制（默认 3 个并发）
- 10 秒超时保护机制
- 完整的调试日志系统

## 注意事项

1. 确保飞书应用有足够的权限访问多维表格
2. 下载大文件时注意网络稳定性
3. 建议使用脚本号筛选功能分批下载大量文件
4. 定期清理下载历史可以释放存储空间

## 开发

如需修改或二次开发，请注意：
- 所有敏感信息在调试模式下会自动脱敏
- 使用 `debug()` 和 `debugError()` 输出调试信息
- 遵循 Chrome 扩展开发最佳实践

## 许可证

MIT License
